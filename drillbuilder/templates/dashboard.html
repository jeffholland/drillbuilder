{% extends 'base.html' %}

{% block content %}
<style>
.drill-item {
  margin: 10px 0;
  padding: 10px;
  border: 1px solid #e6eefb;
  border-radius: 6px;
  background: var(--bg);
}

.drill-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.drill-info {
  flex: 1;
}

.drill-actions {
  display: none;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #e6eefb;
  gap: 8px;
  flex-wrap: wrap;
}

.drill-actions.expanded {
  display: flex;
}

.drill-actions button {
  font-size: 14px;
  padding: 6px 12px;
}

.toggle-actions {
  background: var(--muted);
  padding: 6px 12px;
  font-size: 14px;
  white-space: nowrap;
}
</style>

<div class="card">
  <h2>Your Dashboard</h2>
  <div>
    <button id="logoutBtn">Log out</button>
  </div>

  <h3>Create new drill</h3>
  <form id="newQuizForm">
    <input name="title" placeholder="Title" required />
    <select name="language" id="languageSelect" required style="padding:8px; margin:5px 0;">
      <option value="">-- Select Language --</option>
    </select>
    <label style="display:block; margin:10px 0;">
      <input type="checkbox" name="is_public" /> Make drill public (visible to all users)
    </label>
    <button>Create drill</button>
    <button type="button" onclick="document.getElementById('csvUpload').click()" style="margin-left:10px;">Upload CSV</button>
    <input type="file" id="csvUpload" accept=".csv" style="display:none;" onchange="handleCSVUpload(this)" />
  </form>

  <h3>Your Drills</h3>
  <div id="quizList">Loading…</div>

  <h3 style="margin-top:40px;">Saved Drills</h3>
  <div id="savedQuizList">Loading…</div>
</div>

<div id="shareModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:8px; width:500px; max-width:90%;">
    <h3 id="shareModalTitle">Share Drill</h3>
    <p>Copy this link to share the drill:</p>
    <input type="text" id="shareLink" readonly style="width:100%; padding:8px; margin:10px 0; border:1px solid #ddd; border-radius:4px;" />
    <button onclick="copyShareLink()" style="margin-right:10px;">Copy Link</button>
    <button onclick="downloadDrillCSV()" style="margin-right:10px;">Download CSV</button>
    <button onclick="closeShareModal()">Close</button>
  </div>
</div>

<script>
const token = localStorage.getItem('access_token')
if (!token) {
  window.location = '/register'
}

async function loadLanguages() {
  const r = await fetch('/quizzes/languages')
  const languages = await r.json()
  const select = document.getElementById('languageSelect')
  
  const langHistory = JSON.parse(localStorage.getItem('languageHistory') || '[]')
  
  const usedLangs = []
  const unusedLangs = []
  
  languages.forEach(lang => {
    if (langHistory.includes(lang.code)) {
      usedLangs.push(lang)
    } else {
      unusedLangs.push(lang)
    }
  })
  
  usedLangs.sort((a, b) => langHistory.indexOf(b.code) - langHistory.indexOf(a.code))
  unusedLangs.sort((a, b) => a.name.localeCompare(b.name))
  
  if (usedLangs.length > 0) {
    const recentGroup = document.createElement('optgroup')
    recentGroup.label = 'Recently Used'
    usedLangs.forEach(lang => {
      const option = document.createElement('option')
      option.value = lang.code
      option.textContent = lang.name
      recentGroup.appendChild(option)
    })
    select.appendChild(recentGroup)
  }
  
  if (unusedLangs.length > 0) {
    const otherGroup = document.createElement('optgroup')
    otherGroup.label = 'Other Languages'
    unusedLangs.forEach(lang => {
      const option = document.createElement('option')
      option.value = lang.code
      option.textContent = lang.name
      otherGroup.appendChild(option)
    })
    select.appendChild(otherGroup)
  }
  
  if (langHistory.length > 0) {
    select.value = langHistory[langHistory.length - 1]
  }
}

async function loadQuizzes(){
  const r = await fetch('/quizzes/', {headers: {'Authorization': 'Bearer ' + token}})
  const arr = await r.json()
  
  const r2 = await fetch('/users/me/progress', {headers: {'Authorization': 'Bearer ' + token}})
  const progress = await r2.json()
  const progressMap = {}
  if (Array.isArray(progress)) {
    progress.forEach(p => {
      progressMap[p.quiz_id] = p
    })
  }
  
  const node = document.getElementById('quizList')
  if (!Array.isArray(arr)) { node.innerText = 'Error loading quizzes'; return }
  
  const myQuizzes = arr.filter(q => q.is_mine !== false)
  
  if (!myQuizzes.length) { 
    node.innerText = 'You have not created any drills yet' 
  } else {
    const ul = document.createElement('div')
    myQuizzes.forEach(q => {
      const el = document.createElement('div')
      el.className = 'drill-item'
      const prog = progressMap[q.id]
      const scoreText = prog ? ` <span style="color:var(--muted);font-size:0.9em">Best: ${Math.round(prog.accuracy * 100)}% (${prog.attempts} attempts)</span>` : ''
      const publicBadge = q.is_public ? ' <span style="background:#10b981;color:white;padding:2px 6px;border-radius:3px;font-size:0.8em">PUBLIC</span>' : ''
      const langDisplay = q.language_name || q.language || 'n/a'
      const clearBtn = prog ? `<button data-id="${q.id}" class="clear-results">Clear Results</button>` : ''
      
      el.innerHTML = `
        <div class="drill-header">
          <div class="drill-info">
            <strong>${q.title}</strong>${publicBadge} <span style="color:var(--muted)">(${langDisplay})</span>${scoreText}
          </div>
          <button class="toggle-actions" data-id="${q.id}">Actions ▼</button>
        </div>
        <div class="drill-actions" id="actions-${q.id}">
          <button onclick="window.location.href='/take/${q.id}'">Take Drill</button>
          <button onclick="window.location.href='/quiz-editor?id=${q.id}'">Edit</button>
          <button data-id="${q.id}" class="rename">Rename</button>
          <button data-id="${q.id}" data-title="${q.title}" class="share">Share</button>
          ${clearBtn}
          <button data-id="${q.id}" class="delete" style="background:#ef4444;">Delete</button>
        </div>
      `
      ul.appendChild(el)
    })
    node.innerHTML = ''
    node.appendChild(ul)
  }
  
  const r3 = await fetch('/quizzes/saved', {headers: {'Authorization': 'Bearer ' + token}})
  const savedArr = await r3.json()
  const savedNode = document.getElementById('savedQuizList')
  
  if (!Array.isArray(savedArr) || savedArr.length === 0) {
    savedNode.innerText = 'You have not saved any drills yet'
  } else {
    const ul = document.createElement('div')
    savedArr.forEach(q => {
      const el = document.createElement('div')
      el.className = 'drill-item'
      const prog = progressMap[q.id]
      const scoreText = prog ? ` <span style="color:var(--muted);font-size:0.9em">Best: ${Math.round(prog.accuracy * 100)}% (${prog.attempts} attempts)</span>` : ''
      const langDisplay = q.language_name || q.language || 'n/a'
      const clearBtn = prog ? `<button data-id="${q.id}" class="clear-results">Clear Results</button>` : ''
      
      el.innerHTML = `
        <div class="drill-header">
          <div class="drill-info">
            <strong>${q.title}</strong> <span style="color:var(--muted)">(${langDisplay})</span>${scoreText}
          </div>
          <button class="toggle-actions" data-id="${q.id}">Actions ▼</button>
        </div>
        <div class="drill-actions" id="actions-${q.id}">
          <button onclick="window.location.href='/take/${q.id}'">Take Drill</button>
          <button data-id="${q.id}" data-title="${q.title}" class="share">Share</button>
          ${clearBtn}
          <button data-id="${q.id}" class="unsave" style="background:#ef4444;">Remove</button>
        </div>
      `
      ul.appendChild(el)
    })
    savedNode.innerHTML = ''
    savedNode.appendChild(ul)
  }
}

document.getElementById('newQuizForm').onsubmit = async (e) => {
  e.preventDefault()
  const title = e.target.title.value
  const language = e.target.language.value
  const is_public = e.target.is_public.checked
  
  const langHistory = JSON.parse(localStorage.getItem('languageHistory') || '[]')
  const filtered = langHistory.filter(code => code !== language)
  filtered.push(language)
  const updated = filtered.slice(-10)
  localStorage.setItem('languageHistory', JSON.stringify(updated))
  
  const r = await fetch('/quizzes/', {method:'POST', headers:{'Content-Type':'application/json', 'Authorization':'Bearer ' + token}, body: JSON.stringify({title, language, is_public})})
  const js = await r.json()
  if (r.status === 201) { 
    window.location = '/quiz-editor?id=' + js.id;
  } else { 
    alert('Create failed: ' + JSON.stringify(js)) 
  }
}

document.addEventListener('click', (e) => {
  if (e.target.classList.contains('toggle-actions')) {
    const quizId = e.target.dataset.id;
    const actionsDiv = document.getElementById(`actions-${quizId}`);
    const isExpanded = actionsDiv.classList.contains('expanded');
    
    document.querySelectorAll('.drill-actions.expanded').forEach(div => {
      div.classList.remove('expanded');
    });
    document.querySelectorAll('.toggle-actions').forEach(btn => {
      btn.textContent = 'Actions ▼';
    });
    
    if (!isExpanded) {
      actionsDiv.classList.add('expanded');
      e.target.textContent = 'Actions ▲';
    }
  }
});

document.getElementById('quizList').addEventListener('click', async (e)=>{
  const el = e.target
  if (el.classList.contains('delete')){
    const id = el.dataset.id
    if (!confirm('Delete drill?')) return
    const r = await fetch(`/quizzes/${id}`, {method:'DELETE', headers:{'Authorization':'Bearer ' + token}})
    if (r.status === 200) { 
      loadQuizzes(); 
    } else {
      const err = await r.json();
      alert('Delete failed: ' + (err.msg || JSON.stringify(err)));
    }
  }
  if (el.classList.contains('rename')){
    const id = el.dataset.id
    const newTitle = prompt('New title?')
    if (!newTitle) return
    const r = await fetch(`/quizzes/${id}`, {method:'PUT', headers:{'Content-Type':'application/json','Authorization':'Bearer ' + token}, body: JSON.stringify({title: newTitle})})
    if (r.status === 200) loadQuizzes(); else alert('Rename failed')
  }
  if (el.classList.contains('share')){
    openShareModal(el.dataset.id, el.dataset.title)
  }
  if (el.classList.contains('clear-results')){
    const id = el.dataset.id
    if (!confirm('Clear all your attempt history for this drill? This cannot be undone.')) return
    const r = await fetch(`/quizzes/${id}/clear-results`, {method:'DELETE', headers:{'Authorization':'Bearer ' + token}})
    if (r.status === 200) { 
      alert('Results cleared successfully')
      loadQuizzes(); 
    } else { 
      alert('Failed to clear results')
    }
  }
})

document.getElementById('savedQuizList').addEventListener('click', async (e)=>{
  const el = e.target
  if (el.classList.contains('unsave')){
    const id = el.dataset.id
    if (!confirm('Remove this drill from your collection?')) return
    const r = await fetch(`/quizzes/${id}/save`, {method:'DELETE', headers:{'Authorization':'Bearer ' + token}})
    if (r.status === 200) { 
      loadQuizzes(); 
    } else {
      const err = await r.json();
      alert('Remove failed: ' + (err.msg || JSON.stringify(err)));
    }
  }
  if (el.classList.contains('share')){
    openShareModal(el.dataset.id, el.dataset.title)
  }
  if (el.classList.contains('clear-results')){
    const id = el.dataset.id
    if (!confirm('Clear all your attempt history for this drill? This cannot be undone.')) return
    const r = await fetch(`/quizzes/${id}/clear-results`, {method:'DELETE', headers:{'Authorization':'Bearer ' + token}})
    if (r.status === 200) { 
      alert('Results cleared successfully')
      loadQuizzes(); 
    } else { 
      alert('Failed to clear results')
    }
  }
})

let currentShareQuizId = null;

function openShareModal(quizId, title) {
  currentShareQuizId = quizId;
  const url = `${window.location.origin}/take/${quizId}`;
  document.getElementById('shareLink').value = url;
  document.getElementById('shareModalTitle').innerText = `Share: ${title}`;
  document.getElementById('shareModal').style.display = 'block';
}

function closeShareModal() {
  document.getElementById('shareModal').style.display = 'none';
  currentShareQuizId = null;
}

function copyShareLink() {
  const input = document.getElementById('shareLink');
  input.select();
  document.execCommand('copy');
  alert('Link copied to clipboard!');
}

async function downloadDrillCSV() {
  if (!currentShareQuizId) return;
  
  try {
    const r = await fetch(`/quizzes/${currentShareQuizId}`, {headers: {'Authorization': 'Bearer ' + token}});
    const quiz = await r.json();
    
    let csv = 'Question Type,Question Text,Question Image,Details\n';
    
    quiz.questions.forEach((q, idx) => {
      const qNum = idx + 1;
      const qType = q.type;
      const qText = (q.prompt_text || '').replace(/"/g, '""');
      const qImage = q.prompt_image_url || '';
      
      if (qType === 'multiple_choice') {
        const options = q.options.map(opt => 
          `${opt.is_correct ? '[CORRECT] ' : ''}${opt.text}${opt.image_url ? ' (img: ' + opt.image_url + ')' : ''}`
        ).join(' | ');
        csv += `"Multiple Choice","${qText}","${qImage}","${options}"\n`;
        
      } else if (qType === 'cloze') {
        const blanks = q.cloze_question?.cloze_words || [];
        const blankInfo = blanks.map(b => {
          const alts = b.alternates && b.alternates.length > 0 ? ` (alts: ${b.alternates.join(', ')})` : '';
          return b.word + alts;
        }).join(' | ');
        const fullText = (q.cloze_question?.full_text || q.prompt_text || '').replace(/"/g, '""');
        csv += `"Cloze","${fullText}","${qImage}","Blanks: ${blankInfo}"\n`;
        
      } else if (qType === 'word_match') {
        const pairs = q.word_pairs || [];
        const pairInfo = pairs.map(p => 
          `${p.left_word || '(img)'}${p.left_image_url ? ' [img]' : ''} → ${p.right_word || '(img)'}${p.right_image_url ? ' [img]' : ''}`
        ).join(' | ');
        csv += `"Word Match","Match pairs","${qImage}","${pairInfo}"\n`;
      }
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${quiz.title.replace(/[^a-z0-9]/gi, '_')}_drill.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
  } catch (error) {
    alert('Failed to download CSV: ' + error.message);
  }
}

async function handleCSVUpload(fileInput) {
  const file = fileInput.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const csvText = e.target.result;
      const lines = csvText.split('\n').filter(line => line.trim());
      
      if (lines.length < 2) {
        alert('CSV file is empty or invalid');
        fileInput.value = '';
        return;
      }
      
      const title = prompt('Enter drill title:');
      if (!title) {
        fileInput.value = '';
        return;
      }
      
      const language = prompt('Enter language code (e.g., en, es, fr):');
      if (!language) {
        fileInput.value = '';
        return;
      }
      
      const createResponse = await fetch('/quizzes/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
        body: JSON.stringify({title, language, is_public: false})
      });
      
      if (createResponse.status !== 201) {
        alert('Failed to create drill');
        fileInput.value = '';
        return;
      }
      
      const quiz = await createResponse.json();
      const quizId = quiz.id;
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const fields = parseCSVLine(line);
        if (fields.length < 4) continue;
        
        const [qType, qText, qImage, details] = fields;
        
        let payload = null;
        
        if (qType === 'Multiple Choice') {
          const optionTexts = details.split(' | ').map(opt => opt.trim());
          const options = optionTexts.map(opt => {
            const isCorrect = opt.startsWith('[CORRECT]');
            const text = opt.replace('[CORRECT] ', '').replace(/\s*\(img:.*?\)\s*$/, '');
            return {text, is_correct: isCorrect, image_url: null};
          });
          
          payload = {
            type: 'multiple_choice',
            prompt_text: qText,
            prompt_image_url: qImage || null,
            mcq_options: options
          };
          
        } else if (qType === 'Cloze') {
          const blanksText = details.replace('Blanks: ', '');
          const blankParts = blanksText.split(' | ').map(b => b.trim());
          
          const blanks = [];
          let searchPos = 0;
          
          blankParts.forEach(blankInfo => {
            const match = blankInfo.match(/^(.+?)(?:\s*\(alts:\s*(.+?)\))?$/);
            if (!match) return;
            
            const word = match[1].trim();
            const altsStr = match[2];
            const alternates = altsStr ? altsStr.split(',').map(a => a.trim()) : [];
            
            const pos = qText.indexOf(word, searchPos);
            if (pos !== -1) {
              blanks.push({
                word: word,
                char_position: pos,
                alternates: alternates
              });
              searchPos = pos + word.length;
            }
          });
          
          payload = {
            type: 'cloze',
            prompt_text: qText,
            prompt_image_url: qImage || null,
            cloze_data: {
              full_text: qText,
              blanks: blanks,
              word_bank: false
            }
          };
          
        } else if (qType === 'Word Match') {
          const pairTexts = details.split(' | ').map(p => p.trim());
          const pairs = pairTexts.map(pairText => {
            const parts = pairText.split('→').map(p => p.trim());
            if (parts.length !== 2) return null;
            
            const left = parts[0].replace(/\s*\[img\]\s*$/, '').replace('(img)', '').trim();
            const right = parts[1].replace(/\s*\[img\]\s*$/, '').replace('(img)', '').trim();
            
            return {
              left_word: left || null,
              right_word: right || null,
              left_image_url: null,
              right_image_url: null
            };
          }).filter(p => p !== null);
          
          payload = {
            type: 'word_match',
            prompt_text: qText || 'Match the following words:',
            prompt_image_url: qImage || null,
            word_pairs: pairs
          };
        }
        
        if (payload) {
          await fetch(`/quizzes/${quizId}/questions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
            body: JSON.stringify(payload)
          });
        }
      }
      
      alert(`Drill created successfully with ${lines.length - 1} questions!`);
      fileInput.value = '';
      window.location = '/quiz-editor?id=' + quizId;
      
    } catch (error) {
      alert('Error parsing CSV: ' + error.message);
      fileInput.value = '';
    }
  };
  
  reader.readAsText(file);
}

function parseCSVLine(line) {
  const fields = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];
    
    if (char === '"') {
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      fields.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  
  fields.push(current);
  return fields;
}

document.getElementById('logoutBtn').onclick = ()=>{ localStorage.removeItem('access_token'); window.location = '/' }

loadLanguages()
loadQuizzes()
</script>

{% endblock %}
