{% extends 'base.html' %}

{% block content %}
<div class="card">
  <h2>Create Drill: <span id="quizTitle"></span></h2>
  <p>Add questions to your drill below.</p>

  <div id="questionsList"></div>

  <div class="card" style="margin-top:20px">
    <h3>Add New Question</h3>
    <label>Question Type:
      <select id="questionType">
        <option value="mcq">Multiple Choice (MCQ)</option>
        <option value="cloze">Fill-in-the-Blank (Cloze)</option>
        <option value="word_match">Word Matching</option>
      </select>
    </label>
    <button id="addQuestionBtn">Add Question</button>
  </div>
  <button id="saveQuizBtn" onclick="window.location='/dashboard'">Done</button>
  <button onclick="window.location='/take/' + quizId" style="margin-left:10px;">Run Drill</button>

  <!-- MCQ Editor -->
  <div id="mcqEditor" class="card" style="display:none;margin-top:20px">
    <h3>Multiple Choice Question</h3>
    <label>Question Text:<br/><textarea id="mcqPrompt" rows="3" style="width:100%"></textarea></label>
    <div class="image-upload-container" style="margin:10px 0;">
      <button type="button" class="image-upload-btn" onclick="triggerImageUpload('mcqQuestionImage')" style="font-size:12px;padding:4px 8px;">ðŸ“· Add Image</button>
      <input type="file" id="mcqQuestionImage" accept=".jpg,.jpeg" style="display:none;" onchange="handleImageUpload(this, 'mcqQuestionImagePreview', 'mcqQuestionImageUrl')" />
      <input type="hidden" id="mcqQuestionImageUrl" />
      <div id="mcqQuestionImagePreview" style="margin-top:5px;"></div>
    </div>
    <br/>
    <div id="mcqChoices">
      <div class="mcq-choice">
        <input type="text" placeholder="Choice 1" class="mcq-text" />
        <label><input type="checkbox" class="mcq-correct" /> Correct</label>
        <button type="button" class="choice-image-btn" onclick="triggerImageUpload(this.parentElement.querySelector('.choice-image-input'))" style="font-size:11px;padding:2px 6px;margin-left:8px;">ðŸ“·</button>
        <input type="file" class="choice-image-input" accept=".jpg,.jpeg" style="display:none;" onchange="handleChoiceImageUpload(this)" />
        <input type="hidden" class="choice-image-url" />
        <div class="choice-image-preview" style="display:inline-block;margin-left:5px;"></div>
      </div>
      <div class="mcq-choice">
        <input type="text" placeholder="Choice 2" class="mcq-text" />
        <label><input type="checkbox" class="mcq-correct" /> Correct</label>
        <button type="button" class="choice-image-btn" onclick="triggerImageUpload(this.parentElement.querySelector('.choice-image-input'))" style="font-size:11px;padding:2px 6px;margin-left:8px;">ðŸ“·</button>
        <input type="file" class="choice-image-input" accept=".jpg,.jpeg" style="display:none;" onchange="handleChoiceImageUpload(this)" />
        <input type="hidden" class="choice-image-url" />
        <div class="choice-image-preview" style="display:inline-block;margin-left:5px;"></div>
      </div>
    </div>
    <button id="addMcqChoice">Add Another Choice</button>
    <br/><br/>
    <button id="saveMcq">Save MCQ</button>
    <button id="cancelMcq">Cancel</button>
  </div>

  <!-- Cloze Editor -->
  <div id="clozeEditor" class="card" style="display:none;margin-top:20px">
    <h3>Fill-in-the-Blank (Cloze) Question</h3>
    <div id="clozeStep1">
      <label>Enter your sentence(s) (max 2000 chars):<br/>
        <textarea id="clozeText" rows="4" style="width:100%" maxlength="2000"></textarea>
      </label>
      <div class="image-upload-container" style="margin:10px 0;">
        <button type="button" class="image-upload-btn" onclick="triggerImageUpload('clozeQuestionImage')" style="font-size:12px;padding:4px 8px;">ðŸ“· Add Image</button>
        <input type="file" id="clozeQuestionImage" accept=".jpg,.jpeg" style="display:none;" onchange="handleImageUpload(this, 'clozeQuestionImagePreview', 'clozeQuestionImageUrl')" />
        <input type="hidden" id="clozeQuestionImageUrl" />
        <div id="clozeQuestionImagePreview" style="margin-top:5px;"></div>
      </div>
      <br/>
      <label style="display:block; margin:10px 0;">
        <input type="checkbox" id="clozeWordBank" /> Include word bank (show all blanks in random order)
      </label>
      <button id="clozeNext">Next: Select Blanks</button>
      <button id="cancelClozeStep1">Cancel</button>
    </div>
    <div id="clozeStep2" style="display:none">
      <p>Click on words to select them as blanks. Click "alt" to add alternate answers.</p>
      <div id="clozeWordSelect" style="line-height:2em; position:relative"></div>
      <br/>
      <button id="saveCloze">Save Cloze Question</button>
      <button id="cancelCloze">Cancel</button>
    </div>
  </div>

  <!-- Word Match Editor -->
  <div id="wordMatchEditor" class="card" style="display:none;margin-top:20px">
    <h3>Word Matching Question</h3>
    <p>Create pairs of words that match:</p>
    <div class="image-upload-container" style="margin:10px 0;">
      <button type="button" class="image-upload-btn" onclick="triggerImageUpload('wmQuestionImage')" style="font-size:12px;padding:4px 8px;">ðŸ“· Add Image</button>
      <input type="file" id="wmQuestionImage" accept=".jpg,.jpeg" style="display:none;" onchange="handleImageUpload(this, 'wmQuestionImagePreview', 'wmQuestionImageUrl')" />
      <input type="hidden" id="wmQuestionImageUrl" />
      <div id="wmQuestionImagePreview" style="margin-top:5px;"></div>
    </div>
    <div id="wordMatchPairs">
      <div class="word-match-pair">
        <input type="text" placeholder="Left word" class="wm-left" />
        <button type="button" onclick="triggerWMImageUpload(this, 'left')" style="font-size:11px;padding:2px 6px;margin:0 5px;">ðŸ“·</button>
        <span> â†’ </span>
        <input type="text" placeholder="Right word" class="wm-right" />
        <button type="button" onclick="triggerWMImageUpload(this, 'right')" style="font-size:11px;padding:2px 6px;margin:0 5px;">ðŸ“·</button>
        <input type="file" class="wm-left-image-input" accept=".jpg,.jpeg" style="display:none;" onchange="handleWMImageUpload(this, 'left')" />
        <input type="hidden" class="wm-left-image-url" />
        <input type="file" class="wm-right-image-input" accept=".jpg,.jpeg" style="display:none;" onchange="handleWMImageUpload(this, 'right')" />
        <input type="hidden" class="wm-right-image-url" />
        <div class="wm-left-preview" style="display:inline-block;margin-left:5px;"></div>
        <div class="wm-right-preview" style="display:inline-block;margin-left:5px;"></div>
      </div>
    </div>
    <button id="addWordPair">+ Add Pair</button>
    <br/><br/>
    <button id="saveWordMatch">Save Word Match</button>
    <button id="cancelWordMatch">Cancel</button>
  </div>
</div>

<script>
const token = localStorage.getItem('access_token');
if (!token) { window.location = '/register'; }

const quizId = new URLSearchParams(window.location.search).get('id');
if (!quizId) { window.location = '/dashboard'; }

let clozeSelectedWords = [];

// Image Upload Functions
function triggerImageUpload(inputIdOrElement) {
  const input = typeof inputIdOrElement === 'string' ? 
    document.getElementById(inputIdOrElement) : inputIdOrElement;
  if (input) input.click();
}

async function handleImageUpload(fileInput, previewId, urlInputId) {
  const file = fileInput.files[0];
  if (!file) return;
  
  // Validate file type
  if (!file.name.match(/\.(jpg|jpeg)$/i)) {
    alert('Only .jpg and .jpeg files are allowed');
    fileInput.value = '';
    return;
  }
  
  // Upload file
  const formData = new FormData();
  formData.append('image', file);
  
  try {
    const response = await fetch('/images/upload', {
      method: 'POST',
      headers: {'Authorization': 'Bearer ' + token},
      body: formData
    });
    
    if (response.ok) {
      const data = await response.json();
      document.getElementById(urlInputId).value = data.image_url;
      
      // Show preview
      const preview = document.getElementById(previewId);
      preview.innerHTML = `<img src="${data.image_url}" style="max-width:100px;max-height:100px;border:1px solid #ddd;border-radius:4px;" /> <button type="button" onclick="removeImage('${urlInputId}', '${previewId}')" style="font-size:11px;padding:2px 6px;">âœ•</button>`;
    } else {
      alert('Failed to upload image');
      fileInput.value = '';
    }
  } catch (error) {
    alert('Error uploading image: ' + error.message);
    fileInput.value = '';
  }
}

async function handleChoiceImageUpload(fileInput) {
  const file = fileInput.files[0];
  if (!file) return;
  
  if (!file.name.match(/\.(jpg|jpeg)$/i)) {
    alert('Only .jpg and .jpeg files are allowed');
    fileInput.value = '';
    return;
  }
  
  const formData = new FormData();
  formData.append('image', file);
  
  try {
    const response = await fetch('/images/upload', {
      method: 'POST',
      headers: {'Authorization': 'Bearer ' + token},
      body: formData
    });
    
    if (response.ok) {
      const data = await response.json();
      const choice = fileInput.closest('.mcq-choice');
      choice.querySelector('.choice-image-url').value = data.image_url;
      
      const preview = choice.querySelector('.choice-image-preview');
      preview.innerHTML = `<img src="${data.image_url}" style="max-width:50px;max-height:50px;border:1px solid #ddd;border-radius:3px;vertical-align:middle;" />`;
    } else {
      alert('Failed to upload image');
      fileInput.value = '';
    }
  } catch (error) {
    alert('Error uploading image: ' + error.message);
    fileInput.value = '';
  }
}

async function handleWMImageUpload(fileInput, side) {
  const file = fileInput.files[0];
  if (!file) return;
  
  if (!file.name.match(/\.(jpg|jpeg)$/i)) {
    alert('Only .jpg and .jpeg files are allowed');
    fileInput.value = '';
    return;
  }
  
  const formData = new FormData();
  formData.append('image', file);
  
  try {
    const response = await fetch('/images/upload', {
      method: 'POST',
      headers: {'Authorization': 'Bearer ' + token},
      body: formData
    });
    
    if (response.ok) {
      const data = await response.json();
      const pair = fileInput.closest('.word-match-pair');
      pair.querySelector(`.wm-${side}-image-url`).value = data.image_url;
      
      const preview = pair.querySelector(`.wm-${side}-preview`);
      preview.innerHTML = `<img src="${data.image_url}" style="max-width:50px;max-height:50px;border:1px solid #ddd;border-radius:3px;vertical-align:middle;" />`;
    } else {
      alert('Failed to upload image');
      fileInput.value = '';
    }
  } catch (error) {
    alert('Error uploading image: ' + error.message);
    fileInput.value = '';
  }
}

function triggerWMImageUpload(button, side) {
  const pair = button.closest('.word-match-pair');
  const input = pair.querySelector(`.wm-${side}-image-input`);
  if (input) input.click();
}

function removeImage(urlInputId, previewId) {
  document.getElementById(urlInputId).value = '';
  document.getElementById(previewId).innerHTML = '';
}

async function loadQuiz(){
  const r = await fetch(`/quizzes/${quizId}`, {headers: {'Authorization': 'Bearer ' + token}});
  const quiz = await r.json();
  document.getElementById('quizTitle').innerText = quiz.title || '';
  renderQuestions(quiz.questions || []);
}

let allQuestions = [];

function renderQuestions(questions){
  allQuestions = questions;
  const node = document.getElementById('questionsList');
  if (!questions.length) {
    node.innerHTML = '<p>No questions yet. Add one below!</p>';
  } else {
    node.innerHTML = questions.map((q, idx) => 
      `<div class="card"><strong>Q${idx+1}:</strong> ${q.prompt_text} <small>(${q.type})</small> <button onclick="editQuestion(${q.id})" style="margin-left:10px;">Edit</button> <button onclick="deleteQuestion(${q.id})" style="margin-left:5px;">Delete</button></div>`
    ).join('');
  }
}

function editQuestion(questionId) {
  const question = allQuestions.find(q => q.id === questionId);
  if (!question) return;
  
  hideAllEditors();
  
  if (question.type === 'multiple_choice') {
    // Load MCQ into editor
    document.getElementById('mcqPrompt').value = question.prompt_text;
    document.getElementById('mcqQuestionImageUrl').value = question.prompt_image_url || '';
    if (question.prompt_image_url) {
      document.getElementById('mcqQuestionImagePreview').innerHTML = `<img src="${question.prompt_image_url}" style="max-width:100px;max-height:100px;border:1px solid #ddd;border-radius:4px;" /> <button type="button" onclick="removeImage('mcqQuestionImageUrl', 'mcqQuestionImagePreview')" style="font-size:11px;padding:2px 6px;">âœ•</button>`;
    }
    
    const container = document.getElementById('mcqChoices');
    container.innerHTML = '';
    question.options.forEach(opt => {
      const div = document.createElement('div');
      div.className = 'mcq-choice';
      div.innerHTML = `
        <input type="text" placeholder="Choice" class="mcq-text" value="${opt.text}" />
        <label><input type="checkbox" class="mcq-correct" ${opt.is_correct ? 'checked' : ''} /> Correct</label>
        <button type="button" class="choice-image-btn" onclick="triggerImageUpload(this.parentElement.querySelector('.choice-image-input'))" style="font-size:11px;padding:2px 6px;margin-left:8px;">ðŸ“·</button>
        <input type="file" class="choice-image-input" accept=".jpg,.jpeg" style="display:none" onchange="handleChoiceImageUpload(this)" />
        <input type="hidden" class="choice-image-url" value="${opt.image_url || ''}" />
        <div class="choice-image-preview" style="display:inline-block;margin-left:5px;">${opt.image_url ? `<img src="${opt.image_url}" style="max-width:50px;max-height:50px;border:1px solid #ddd;border-radius:3px;vertical-align:middle;" />` : ''}</div>
        <button class="delete-choice" style="margin-left:10px">Delete</button>
      `;
      container.appendChild(div);
    });
    
    updateDeleteButtons();
    document.getElementById('mcqEditor').style.display = 'block';
    
    // Change save button to update
    const saveBtn = document.getElementById('saveMcq');
    saveBtn.innerText = 'Update MCQ';
    saveBtn.onclick = () => updateMcq(questionId);
    
  } else if (question.type === 'cloze') {
    // Load Cloze into editor - start at step 1 to allow text editing
    const clozeData = question.cloze_question;
    if (!clozeData) {
      alert('Invalid cloze question data');
      return;
    }
    
    document.getElementById('clozeText').value = clozeData.full_text;
    document.getElementById('clozeQuestionImageUrl').value = question.prompt_image_url || '';
    document.getElementById('clozeWordBank').checked = clozeData.word_bank || false;
    
    if (question.prompt_image_url) {
      document.getElementById('clozeQuestionImagePreview').innerHTML = `<img src="${question.prompt_image_url}" style="max-width:100px;max-height:100px;border:1px solid #ddd;border-radius:4px;" /> <button type="button" onclick="removeImage('clozeQuestionImageUrl', 'clozeQuestionImagePreview')" style="font-size:11px;padding:2px 6px;">âœ•</button>`;
    }
    
    // Store existing blanks data for restoration in step 2
    const existingBlanks = (clozeData.cloze_words || clozeData.blanks || []).map(b => ({
      word: b.correct_answer || b.word,
      char_position: b.char_position,
      alternates: b.alternate_answers || b.alternates || []
    }));
    
    // Store in a temporary variable accessible to the Next button
    window.editingClozeData = { existingBlanks };
    
    // Show step 1
    document.getElementById('clozeStep1').style.display = 'block';
    document.getElementById('clozeStep2').style.display = 'none';
    document.getElementById('clozeEditor').style.display = 'block';
    
    // Change save button to update (in case they go to step 2)
    const clozeBtn = document.getElementById('saveCloze');
    clozeBtn.innerText = 'Update Cloze';
    clozeBtn.onclick = () => updateCloze(questionId);
    
  } else if (question.type === 'word_match') {
    alert('Editing word match questions is not yet implemented. Please delete and recreate.');
  }
}

async function updateMcq(questionId) {
  const prompt = document.getElementById('mcqPrompt').value.trim();
  if (!prompt) { alert('Question text required'); return; }
  
  const questionImageUrl = document.getElementById('mcqQuestionImageUrl').value || null;
  
  const choices = Array.from(document.querySelectorAll('.mcq-choice')).map(c => ({
    text: c.querySelector('.mcq-text').value.trim(),
    is_correct: c.querySelector('.mcq-correct').checked,
    image_url: c.querySelector('.choice-image-url').value || null
  }));
  if (choices.length < 2) { alert('At least 2 choices required'); return; }
  if (!choices.some(c => c.is_correct)) { alert('Mark at least one choice as correct'); return; }

  // Delete old question and create new one (simpler than updating)
  const delR = await fetch(`/quizzes/${quizId}/questions/${questionId}`, {
    method: 'DELETE',
    headers: {'Authorization': 'Bearer ' + token}
  });
  
  if (delR.ok) {
    const payload = {
      type: 'multiple_choice',
      prompt_text: prompt,
      prompt_image_url: questionImageUrl,
      mcq_options: choices
    };
    const r = await fetch(`/quizzes/${quizId}/questions`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
      body: JSON.stringify(payload)
    });
    if (r.status === 201) {
      resetMcqEditor();
      hideAllEditors();
      loadQuiz();
    } else {
      alert('Failed to update MCQ');
    }
  } else {
    alert('Failed to delete old question');
  }
}

function resetMcqEditor() {
  document.getElementById('mcqPrompt').value = '';
  document.getElementById('mcqQuestionImageUrl').value = '';
  document.getElementById('mcqQuestionImagePreview').innerHTML = '';
  document.getElementById('mcqChoices').innerHTML = `
    <div class="mcq-choice">
      <input type="text" placeholder="Choice 1" class="mcq-text" />
      <label><input type="checkbox" class="mcq-correct" /> Correct</label>
      <button type="button" class="choice-image-btn" onclick="triggerImageUpload(this.parentElement.querySelector('.choice-image-input'))" style="font-size:11px;padding:2px 6px;margin-left:8px;">ðŸ“·</button>
      <input type="file" class="choice-image-input" accept=".jpg,.jpeg" style="display:none" onchange="handleChoiceImageUpload(this)" />
      <input type="hidden" class="choice-image-url" />
      <div class="choice-image-preview" style="display:inline-block;margin-left:5px;"></div>
    </div>
    <div class="mcq-choice">
      <input type="text" placeholder="Choice 2" class="mcq-text" />
      <label><input type="checkbox" class="mcq-correct" /> Correct</label>
      <button type="button" class="choice-image-btn" onclick="triggerImageUpload(this.parentElement.querySelector('.choice-image-input'))" style="font-size:11px;padding:2px 6px;margin-left:8px;">ðŸ“·</button>
      <input type="file" class="choice-image-input" accept=".jpg,.jpeg" style="display:none" onchange="handleChoiceImageUpload(this)" />
      <input type="hidden" class="choice-image-url" />
      <div class="choice-image-preview" style="display:inline-block;margin-left:5px;"></div>
    </div>
  `;
  
  // Reset save button
  const saveBtn = document.getElementById('saveMcq');
  saveBtn.innerText = 'Save MCQ';
  saveBtn.onclick = saveMcqOriginal;
}

async function deleteQuestion(questionId) {
  if (!confirm('Delete this question?')) return;
  
  const r = await fetch(`/quizzes/${quizId}/questions/${questionId}`, {
    method: 'DELETE',
    headers: {'Authorization': 'Bearer ' + token}
  });
  
  if (r.ok) {
    loadQuiz();
  } else {
    alert('Failed to delete question');
  }
}

document.getElementById('addQuestionBtn').onclick = () => {
  const type = document.getElementById('questionType').value;
  hideAllEditors();
  if (type === 'mcq') {
    document.getElementById('mcqEditor').style.display = 'block';
    updateDeleteButtons();  // Add delete buttons to initial choices
  } else if (type === 'cloze') {
    document.getElementById('clozeEditor').style.display = 'block';
  } else if (type === 'word_match') {
    document.getElementById('wordMatchEditor').style.display = 'block';
  }
};

function hideAllEditors(){
  document.getElementById('mcqEditor').style.display = 'none';
  document.getElementById('clozeEditor').style.display = 'none';
  document.getElementById('wordMatchEditor').style.display = 'none';
}

// MCQ Editor
document.getElementById('addMcqChoice').onclick = () => {
  const container = document.getElementById('mcqChoices');
  const div = document.createElement('div');
  div.className = 'mcq-choice';
  div.innerHTML = `
    <input type="text" placeholder="Choice" class="mcq-text" />
    <label><input type="checkbox" class="mcq-correct" /> Correct</label>
    <button type="button" class="choice-image-btn" onclick="triggerImageUpload(this.parentElement.querySelector('.choice-image-input'))" style="font-size:11px;padding:2px 6px;margin-left:8px;">ðŸ“·</button>
    <input type="file" class="choice-image-input" accept=".jpg,.jpeg" style="display:none;" onchange="handleChoiceImageUpload(this)" />
    <input type="hidden" class="choice-image-url" />
    <div class="choice-image-preview" style="display:inline-block;margin-left:5px;"></div>
    <button class="delete-choice" style="margin-left:10px">Delete</button>
  `;
  container.appendChild(div);
  updateDeleteButtons();
};

function updateDeleteButtons(){
  const choices = document.querySelectorAll('.mcq-choice');
  choices.forEach(c => {
    let btn = c.querySelector('.delete-choice');
    
    // Create delete button if it doesn't exist
    if (!btn) {
      btn = document.createElement('button');
      btn.className = 'delete-choice';
      btn.style.marginLeft = '10px';
      btn.innerText = 'Delete';
      c.appendChild(btn);
    }
    
    // Show/hide based on number of choices
    if (choices.length > 2) {
      btn.style.display = 'inline';
      btn.onclick = () => { c.remove(); updateDeleteButtons(); };
    } else {
      btn.style.display = 'none';
    }
  });
}

// Store original save function
const saveMcqOriginal = async () => {
  const prompt = document.getElementById('mcqPrompt').value.trim();
  if (!prompt) { alert('Question text required'); return; }
  
  const questionImageUrl = document.getElementById('mcqQuestionImageUrl').value || null;
  
  const choices = Array.from(document.querySelectorAll('.mcq-choice')).map(c => ({
    text: c.querySelector('.mcq-text').value.trim(),
    is_correct: c.querySelector('.mcq-correct').checked,
    image_url: c.querySelector('.choice-image-url').value || null
  }));
  if (choices.length < 2) { alert('At least 2 choices required'); return; }
  if (!choices.some(c => c.is_correct)) { alert('Mark at least one choice as correct'); return; }

  const payload = {
    type: 'multiple_choice',
    prompt_text: prompt,
    prompt_image_url: questionImageUrl,
    mcq_options: choices
  };
  const r = await fetch(`/quizzes/${quizId}/questions`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
    body: JSON.stringify(payload)
  });
  if (r.status === 201) {
    resetMcqEditor();
    hideAllEditors();
    loadQuiz();
  } else {
    alert('Failed to save MCQ');
  }
};

document.getElementById('saveMcq').onclick = saveMcqOriginal;

document.getElementById('cancelMcq').onclick = () => hideAllEditors();

// Cloze Editor
let clozeWordData = {}; // Store word data including alternates

document.getElementById('clozeNext').onclick = () => {
  const text = document.getElementById('clozeText').value.trim();
  if (!text) { alert('Enter text first'); return; }
  document.getElementById('clozeStep1').style.display = 'none';
  document.getElementById('clozeStep2').style.display = 'block';
  
  clozeWordData = {}; // Reset word data
  const words = text.split(/\s+/);
  const container = document.getElementById('clozeWordSelect');
  container.innerHTML = '';
  let charPos = 0;
  
  // Get existing blanks if we're editing
  const existingBlanks = window.editingClozeData?.existingBlanks || [];
  let removedCount = 0;
  
  words.forEach((word, idx) => {
    const wrapper = document.createElement('span');
    wrapper.style.position = 'relative';
    wrapper.style.display = 'inline-block';
    wrapper.style.marginRight = '5px';
    
    const span = document.createElement('span');
    span.innerText = word;
    span.style.cursor = 'pointer';
    span.dataset.word = word;
    const wordCharPos = charPos; // Capture the position for this word
    span.dataset.pos = wordCharPos;
    console.log(`Setting position to ${wordCharPos} for word "${word}" at index ${idx}`);
    span.dataset.idx = idx;
    span.className = 'cloze-word';
    
    // Check if this word was previously a blank at this exact position
    const existingBlank = existingBlanks.find(b => b.char_position === wordCharPos && b.word === word);
    
    if (existingBlank) {
      // Restore the blank with its data
      span.classList.add('selected');
      span.style.background = 'yellow';
      clozeWordData[idx] = { 
        word: existingBlank.word, 
        pos: wordCharPos, 
        alternates: [...existingBlank.alternates] 
      };
      
      // Update display with alternates
      if (existingBlank.alternates.length > 0) {
        span.innerText = [existingBlank.word, ...existingBlank.alternates].join('/');
      }
      
      // Add "alt" button
      const altBtn = document.createElement('span');
      altBtn.className = 'alt-btn';
      altBtn.innerText = 'alt';
      altBtn.style.cssText = 'position:absolute; top:-20px; right:-5px; background:black; color:white; padding:2px 4px; font-size:10px; cursor:pointer; border-radius:3px; z-index:10; display:none;';
      altBtn.onclick = (e) => {
        e.stopPropagation();
        showAltInput(idx, span, wrapper);
      };
      wrapper.appendChild(altBtn);
      
      wrapper.onmouseenter = () => {
        const btn = wrapper.querySelector('.alt-btn');
        if (btn) btn.style.display = 'block';
      };
      wrapper.onmouseleave = () => {
        const btn = wrapper.querySelector('.alt-btn');
        if (btn) btn.style.display = 'none';
      };
    }
    
    span.onclick = () => {
      const isSelected = span.classList.contains('selected');
      span.classList.toggle('selected');
      
      if (!isSelected) {
        // Selecting the word
        span.style.background = 'yellow';
        clozeWordData[idx] = { word, pos: wordCharPos, alternates: [] };

        // Add "alt" button (hidden by default, shown on hover)
        const altBtn = document.createElement('span');
        altBtn.className = 'alt-btn';
        altBtn.innerText = 'alt';
        altBtn.style.cssText = 'position:absolute; top:-20px; right:-5px; background:black; color:white; padding:2px 4px; font-size:10px; cursor:pointer; border-radius:3px; z-index:10; display:none;';
        altBtn.onclick = (e) => {
          e.stopPropagation();
          showAltInput(idx, span, wrapper);
        };
        wrapper.appendChild(altBtn);
        
        // Show/hide alt button on hover
        wrapper.onmouseenter = () => {
          const btn = wrapper.querySelector('.alt-btn');
          if (btn) btn.style.display = 'block';
        };
        wrapper.onmouseleave = () => {
          const btn = wrapper.querySelector('.alt-btn');
          if (btn) btn.style.display = 'none';
        };
      } else {
        // Deselecting the word
        span.style.background = '';
        delete clozeWordData[idx];
        // Remove alt button and any alt input
        const altBtn = wrapper.querySelector('.alt-btn');
        if (altBtn) altBtn.remove();
        const altInput = wrapper.querySelector('.alt-input-container');
        if (altInput) altInput.remove();
      }
      
      updateWordDisplay(idx, span);
    };
    
    wrapper.appendChild(span);
    container.appendChild(wrapper);
    container.appendChild(document.createTextNode(' '));
    charPos += word.length + 1;
  });
  
  // Count how many blanks were removed
  removedCount = existingBlanks.length - Object.keys(clozeWordData).length;
  if (removedCount > 0) {
    console.log(`Removed ${removedCount} blank(s) that no longer match original position/word`);
  }
  
  // Clear the editing data
  delete window.editingClozeData;
};

function showAltInput(idx, span, wrapper) {
  // Remove any existing alt input
  const existing = wrapper.querySelector('.alt-input-container');
  if (existing) existing.remove();
  
  const altContainer = document.createElement('div');
  altContainer.className = 'alt-input-container';
  altContainer.style.cssText = 'position:absolute; top:100%; left:0; background:white; border:1px solid #ccc; padding:5px; z-index:20; box-shadow:0 2px 5px rgba(0,0,0,0.2); min-width:150px;';
  
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Alternate answer';
  input.style.cssText = 'width:100%; padding:4px; margin-bottom:5px;';
  
  const submitBtn = document.createElement('button');
  submitBtn.innerText = 'Add';
  submitBtn.style.marginRight = '5px';
  submitBtn.onclick = (e) => {
    e.stopPropagation();
    const altText = input.value.trim();
    if (altText) {
      clozeWordData[idx].alternates.push(altText);
      updateWordDisplay(idx, span);
      altContainer.remove();
    }
  };
  
  const cancelBtn = document.createElement('button');
  cancelBtn.innerText = 'Cancel';
  cancelBtn.onclick = (e) => {
    e.stopPropagation();
    altContainer.remove();
  };
  
  altContainer.appendChild(input);
  altContainer.appendChild(submitBtn);
  altContainer.appendChild(cancelBtn);
  wrapper.appendChild(altContainer);
  input.focus();
}

function updateWordDisplay(idx, span) {
  if (clozeWordData[idx]) {
    const data = clozeWordData[idx];
    const allWords = [data.word, ...data.alternates];
    span.innerText = allWords.join('/');
  }
}

document.getElementById('cancelClozeStep1').onclick = () => {
  resetClozeEditor();
  hideAllEditors();
};

async function updateCloze(questionId) {
  const text = document.getElementById('clozeText').value.trim();
  const wordBank = document.getElementById('clozeWordBank').checked;
  const clozeQuestionImageUrl = document.getElementById('clozeQuestionImageUrl').value || null;
  
  const blanks = Object.values(clozeWordData).map(data => ({
    word: data.word,
    char_position: data.pos,
    alternates: data.alternates
  }));

  if (!blanks.length) { alert('Select at least one word as blank'); return; }

  // Delete old question and create new one
  const delR = await fetch(`/quizzes/${quizId}/questions/${questionId}`, {
    method: 'DELETE',
    headers: {'Authorization': 'Bearer ' + token}
  });
  
  if (delR.ok) {
    const payload = {
      type: 'cloze',
      prompt_text: text,
      prompt_image_url: clozeQuestionImageUrl,
      cloze_data: { 
        full_text: text, 
        blanks,
        word_bank: wordBank
      }
    };
    
    const r = await fetch(`/quizzes/${quizId}/questions`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
      body: JSON.stringify(payload)
    });
    
    if (r.status === 201) {
      resetClozeEditor();
      hideAllEditors();
      loadQuiz();
    } else {
      alert('Failed to update cloze');
    }
  } else {
    alert('Failed to delete old question');
  }
}

function resetClozeEditor() {
  document.getElementById('clozeText').value = '';
  document.getElementById('clozeWordBank').checked = false;
  document.getElementById('clozeQuestionImageUrl').value = '';
  document.getElementById('clozeQuestionImagePreview').innerHTML = '';
  document.getElementById('clozeStep1').style.display = 'block';
  document.getElementById('clozeStep2').style.display = 'none';
  clozeWordData = {};
  
  // Clear any editing data
  delete window.editingClozeData;
  
  // Reset save button
  const clozeBtn = document.getElementById('saveCloze');
  clozeBtn.innerText = 'Save Cloze Question';
  clozeBtn.onclick = saveClozeOriginal;
}

const saveClozeOriginal = async () => {
  const text = document.getElementById('clozeText').value.trim();
  const wordBank = document.getElementById('clozeWordBank').checked;
  const clozeQuestionImageUrl = document.getElementById('clozeQuestionImageUrl').value || null;
  
  const blanks = Object.values(clozeWordData).map(data => ({
    word: data.word,
    char_position: data.pos,
    alternates: data.alternates
  }));

  console.log('Cloze blanks:', blanks);
  
  if (!blanks.length) { alert('Select at least one word as blank'); return; }

  const payload = {
    type: 'cloze',
    prompt_text: text,
    prompt_image_url: clozeQuestionImageUrl,
    cloze_data: { 
      full_text: text, 
      blanks,
      word_bank: wordBank
    }
  };
  
  const r = await fetch(`/quizzes/${quizId}/questions`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
    body: JSON.stringify(payload)
  });
  
  if (r.status === 201) {
    resetClozeEditor();
    hideAllEditors();
    loadQuiz();
  } else {
    alert('Failed to save cloze');
  }
};

document.getElementById('saveCloze').onclick = saveClozeOriginal;

document.getElementById('cancelCloze').onclick = () => {
  resetClozeEditor();
  hideAllEditors();
};

// Word Match Editor
document.getElementById('addWordPair').onclick = () => {
  const container = document.getElementById('wordMatchPairs');
  const div = document.createElement('div');
  div.className = 'word-match-pair';
  div.innerHTML = `
    <input type="text" placeholder="Left word" class="wm-left" />
    <button type="button" onclick="triggerWMImageUpload(this, 'left')" style="font-size:11px;padding:2px 6px;margin:0 5px;">ðŸ“·</button>
    <span> â†’ </span>
    <input type="text" placeholder="Right word" class="wm-right" />
    <button type="button" onclick="triggerWMImageUpload(this, 'right')" style="font-size:11px;padding:2px 6px;margin:0 5px;">ðŸ“·</button>
    <input type="file" class="wm-left-image-input" accept=".jpg,.jpeg" style="display:none;" onchange="handleWMImageUpload(this, 'left')" />
    <input type="hidden" class="wm-left-image-url" />
    <input type="file" class="wm-right-image-input" accept=".jpg,.jpeg" style="display:none;" onchange="handleWMImageUpload(this, 'right')" />
    <input type="hidden" class="wm-right-image-url" />
    <div class="wm-left-preview" style="display:inline-block;margin-left:5px;"></div>
    <div class="wm-right-preview" style="display:inline-block;margin-left:5px;"></div>
    <button class="delete-pair" style="margin-left:10px">Delete</button>
  `;
  container.appendChild(div);
  updateWordPairDelete();
};

function updateWordPairDelete(){
  const pairs = document.querySelectorAll('.word-match-pair');
  pairs.forEach(p => {
    const btn = p.querySelector('.delete-pair');
    if (pairs.length > 1 && btn) {
      btn.style.display = 'inline';
      btn.onclick = () => { p.remove(); updateWordPairDelete(); };
    } else if (btn) {
      btn.style.display = 'none';
    }
  });
}

document.getElementById('saveWordMatch').onclick = async () => {
  const wmQuestionImageUrl = document.getElementById('wmQuestionImageUrl').value || null;
  const pairs = Array.from(document.querySelectorAll('.word-match-pair')).map(p => ({
    left: p.querySelector('.wm-left').value.trim(),
    right: p.querySelector('.wm-right').value.trim(),
    left_image_url: p.querySelector('.wm-left-image-url').value || null,
    right_image_url: p.querySelector('.wm-right-image-url').value || null
  }));
  
  // Validate: require text unless image is provided
  if (!pairs.length) {
    alert('Add at least one word pair'); return;
  }
  
  for (const p of pairs) {
    const hasLeftText = !!p.left;
    const hasLeftImage = !!p.left_image_url;
    const hasRightText = !!p.right;
    const hasRightImage = !!p.right_image_url;
    
    if (!hasLeftText && !hasLeftImage) {
      alert('Each pair must have left text or image'); return;
    }
    if (!hasRightText && !hasRightImage) {
      alert('Each pair must have right text or image'); return;
    }
  }

  const payload = {
    type: 'word_match',
    prompt_text: 'Match the following words:',
    prompt_image_url: wmQuestionImageUrl,
    word_pairs: pairs
  };
  const r = await fetch(`/quizzes/${quizId}/questions`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
    body: JSON.stringify(payload)
  });
  if (r.status === 201) {
    alert('Word match question added!');
    document.getElementById('wmQuestionImageUrl').value = '';
    document.getElementById('wmQuestionImagePreview').innerHTML = '';
    document.getElementById('wordMatchPairs').innerHTML = `
      <div class="word-match-pair">
        <input type="text" placeholder="Left word" class="wm-left" />
        <button class="wm-left-image-btn" style="font-size:11px;padding:2px 4px;margin-left:4px" onclick="triggerWMImageUpload(this, 'left')">ðŸ“·</button>
        <input type="file" class="wm-left-image-input" accept=".jpg,.jpeg" style="display:none" onchange="handleWMImageUpload(this, 'left')" />
        <input type="hidden" class="wm-left-image-url" />
        <div class="wm-left-image-preview" style="display:inline-block;margin-left:4px"></div>
        <span> â†’ </span>
        <input type="text" placeholder="Right word" class="wm-right" />
        <button class="wm-right-image-btn" style="font-size:11px;padding:2px 4px;margin-left:4px" onclick="triggerWMImageUpload(this, 'right')">ðŸ“·</button>
        <input type="file" class="wm-right-image-input" accept=".jpg,.jpeg" style="display:none" onchange="handleWMImageUpload(this, 'right')" />
        <input type="hidden" class="wm-right-image-url" />
        <div class="wm-right-image-preview" style="display:inline-block;margin-left:4px"></div>
      </div>
    `;
    hideAllEditors();
    loadQuiz();
  } else {
    alert('Failed to save word match');
  }
};

document.getElementById('cancelWordMatch').onclick = () => hideAllEditors();

loadQuiz();
</script>

{% endblock %}
